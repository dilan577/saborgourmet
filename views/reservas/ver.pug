extends ../layouts/main

block content
  .px-4.sm_px-0
    .flex.justify-between.items-center
      div
        h1.text-3xl.font-bold.text-gray-900= titulo
        if reserva.cliente
          p.mt-2.text-sm.text-gray-600= `Reserva para ${reserva.cliente.nombre} ${reserva.cliente.apellido}`
        else
          p.mt-2.text-sm.text-gray-600 Cliente no asignado

      .flex.space-x-2
        if rol === 'admin' || rol === 'mesero'
          button.btn-secondary(type="button" onclick="window.history.back()") Volver

  .mt-8.grid.grid-cols-1.gap-6.lg_grid-cols-2
    .card
      h3.text-lg.font-semibold.mb-4 Información de la Reserva
      .space-y-3
        div
          p.text-sm.text-gray-600 Fecha
          p.font-semibold= reserva.fecha

        div
          p.text-sm.text-gray-600 Hora
          p.font-semibold= reserva.hora?.substring(0,5) || '-'

        div
          p.text-sm.text-gray-600 Número de Personas
          p.font-semibold= reserva.numeroPersonas

        div
          p.text-sm.text-gray-600 Mesa
          p.font-semibold= reserva.mesa ? `${reserva.mesa.numero} - ${reserva.mesa.zona}` : 'Sin asignar'

        div
          p.text-sm.text-gray-600 Estado
          span.badge(
            class={
              "badge-warning": reserva.estado === 'pendiente',
              "badge-success": reserva.estado === 'confirmada' || reserva.estado === 'atendida',
              "badge-danger": reserva.estado === 'cancelada' || reserva.estado === 'no_show'
            }
          )= reserva.estado

    .card
      h3.text-lg.font-semibold.mb-4 Información del Cliente
      if reserva.cliente
        .space-y-3
          div
            p.text-sm.text-gray-600 Nombre
            p.font-semibold= `${reserva.cliente.nombre} ${reserva.cliente.apellido}`

          div
            p.text-sm.text-gray-600 Email
            p.font-semibold= reserva.cliente.email || '-'

          div
            p.text-sm.text-gray-600 Teléfono
            p.font-semibold= reserva.cliente.telefono || '-'
      else
        p.text-gray-500 No hay cliente asociado

  if rol === 'admin' || rol === 'mesero'
    .mt-8.card
      h3.text-lg.font-semibold.mb-4 Acciones
      .flex.flex-wrap.gap-3

        if reserva.estado === 'pendiente'
          button.btn-success(onclick=`cambiarEstado(${reserva.id}, 'confirmada')`) Confirmar
          button.btn-danger(onclick=`cambiarEstado(${reserva.id}, 'cancelada')`) Cancelar

        if reserva.estado === 'confirmada'
          button.btn-primary(onclick=`cambiarEstado(${reserva.id}, 'atendida')`) Marcar Atendida
          button.btn-warning(onclick=`cambiarEstado(${reserva.id}, 'no_show')`) No Show

  script.
    async function cambiarEstado(id, estado) {
      if (estado === 'cancelada') {
        if (!confirm('¿Cancelar esta reserva?')) return;
      }

      if (estado === 'no_show') {
        if (!confirm('¿Marcar como No-Show?')) return;
      }

      try {
        const res = await fetch(`/reservas/${id}/estado`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ estado })
        });

        const data = await res.json();

        if (data.ok) {
          location.reload();
        } else {
          alert(data.error || 'Error al actualizar la reserva');
        }
      } catch (e) {
        alert('Error de conexión');
      }
    }
