extends ../layouts/main

block content
  .px-4.sm_px-0
    .flex.justify-between.items-center
      div
        h1.text-3xl.font-bold.text-gray-900= titulo
        if reserva.cliente
          p.mt-2.text-sm.text-gray-600= `Reserva para ${reserva.cliente.nombre} ${reserva.cliente.apellido}`
        else
          p.mt-2.text-sm.text-gray-600 Cliente no asignado

      .flex.space-x-2
        if rol === 'admin' || rol === 'mesero'
          a.btn-secondary(href=`/reservas/${reserva.id}/editar`) Editar
          button.btn-secondary(type="button" onclick="window.history.back()") Volver

  .mt-8.grid.grid-cols-1.gap-6.lg_grid-cols-2
    .card
      h3.text-lg.font-semibold.text-gray-900.mb-4 Información de la Reserva
      .space-y-3
        div
          p.text-sm.text-gray-600 Fecha
          p.font-semibold= reserva.fecha

        div
          p.text-sm.text-gray-600 Hora
          p.font-semibold= reserva.hora ? reserva.hora.substring(0, 5) : '-'

        div
          p.text-sm.text-gray-600 Número de Personas
          p.font-semibold= reserva.numeroPersonas

        div
          p.text-sm.text-gray-600 Mesa
          p.font-semibold= reserva.mesa ? `${reserva.mesa.numero} - ${reserva.mesa.zona}` : 'Sin asignar'

        div
          p.text-sm.text-gray-600 Estado
          span.badge(
            class={
              "badge-warning": reserva.estado === 'pendiente',
              "badge-success": reserva.estado === 'confirmada' || reserva.estado === 'completada',
              "badge-info": reserva.estado === 'en_curso',
              "badge-danger": reserva.estado === 'cancelada' || reserva.estado === 'no_show'
            }
          )= reserva.estado

    .card
      h3.text-lg.font-semibold.text-gray-900.mb-4 Información del Cliente
      if reserva.cliente
        .space-y-3
          div
            p.text-sm.text-gray-600 Nombre
            p.font-semibold= `${reserva.cliente.nombre} ${reserva.cliente.apellido}`

          div
            p.text-sm.text-gray-600 Email
            p.font-semibold= reserva.cliente.email || '-'

          div
            p.text-sm.text-gray-600 Teléfono
            p.font-semibold= reserva.cliente.telefono || '-'

          div
            a.text-primary-600.hover_text-primary-900(
              href=`/clientes/${reserva.cliente.id}`
            ) Ver historial del cliente
      else
        p.text-gray-500 No hay cliente asociado a esta reserva

  if reserva.notas
    .mt-6.card
      h3.text-lg.font-semibold.text-gray-900.mb-2 Notas
      p.text-gray-700= reserva.notas

  if reserva.motivoCancelacion
    .mt-6.card.bg-red-50
      h3.text-lg.font-semibold.text-red-900.mb-2 Motivo de Cancelación
      p.text-red-700= reserva.motivoCancelacion

  if rol === 'admin' || rol === 'mesero'
    .mt-8.card
      h3.text-lg.font-semibold.text-gray-900.mb-4 Acciones
      .flex.flex-wrap.gap-3
        if reserva.estado === 'pendiente'
          button.btn-success(onclick=`confirmar(${reserva.id})`) Confirmar
          button.btn-danger(onclick=`cancelar(${reserva.id})`) Cancelar

        if reserva.estado === 'confirmada'
          button.btn-primary(onclick=`marcarEnCurso(${reserva.id})`) Marcar En Curso
          button.btn-danger(onclick=`cancelar(${reserva.id})`) Cancelar

        if reserva.estado === 'en_curso'
          button.btn-success(onclick=`completar(${reserva.id})`) Completar
          button.btn-warning(onclick=`marcarNoShow(${reserva.id})`) Marcar No-Show

  script.
    async function confirmar(id) {
      try {
        const res = await fetch(`/reservas/${id}/confirmar`, { method: 'POST' });
        const data = await res.json();
        if (data.success) location.reload();
      } catch (e) {
        alert('Error al confirmar reserva');
      }
    }

    async function cancelar(id) {
      const motivo = prompt('Motivo de cancelación:');
      if (!motivo) return;

      try {
        const res = await fetch(`/reservas/${id}/cancelar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ motivoCancelacion: motivo })
        });
        const data = await res.json();
        if (data.success) location.reload();
      } catch (e) {
        alert('Error al cancelar reserva');
      }
    }

    async function marcarEnCurso(id) {
      try {
        const res = await fetch(`/reservas/${id}/en-curso`, { method: 'POST' });
        const data = await res.json();
        if (data.success) location.reload();
      } catch (e) {
        alert('Error al actualizar reserva');
      }
    }

    async function completar(id) {
      try {
        const res = await fetch(`/reservas/${id}/completar`, { method: 'POST' });
        const data = await res.json();
        if (data.success) location.reload();
      } catch (e) {
        alert('Error al completar reserva');
      }
    }

    async function marcarNoShow(id) {
      if (!confirm('¿Marcar como No-Show?')) return;

      try {
        const res = await fetch(`/reservas/${id}/no-show`, { method: 'POST' });
        const data = await res.json();
        if (data.success) location.reload();
      } catch (e) {
        alert('Error al marcar No-Show');
      }
    }
